name: Dependabot

on: push

env:
  ORG: tiki

jobs:
  get-org-repos:
    runs-on: ubuntu-latest
    steps:
      - uses: austenstone/get-org-repos@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          org: ${{ env.ORG }}
        id: get-org-repos
    outputs:
      repos: ${{ steps.get-org-repos.outputs.repos }}

  build:
    needs: [ get-org-repos ]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        repo: ${{ fromJson(needs.get-org-repos.outputs.repos) }}
      fail-fast: false
    steps:
      - name: Get Dependabot PRs
        id: dependabot-prs
        run: echo "prs=$(gh pr list -R ${{ env.ORG }}/${{ matrix.repo }} -A app/dependabot --json title,url)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create Body
        if: ${{ steps.dependabot-prs.outputs.prs != '[]' }}
        run: |
          for value in ${{ fromJson(steps.dependabot-prs.outputs.prs) }}
          do
            echo $value['title']: $value['url']
          done

#  create-issue:
#    if: ${{ github.event_name == 'pull_request' && needs.check-dependabot.outputs.dependabot == 'true'}}
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v2
#      - name: Open issue
#        env:
#          pr_title: ${{github.event.pull_request.title}}
#          pr_number: ${{github.event.pull_request.number}}
#          pr_url: ${{github.event.pull_request.url}}
#          issue_labels: chore
#          gh_project:
#        run: |
#          title="$pr_title (#$pr_number)"
#          body="Dependabot has opened PR: $pr_url"
#          gh issue create --title "$title" --body "$body" --label "issue_labels" --project
